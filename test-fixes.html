<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fixes - Image & TTS - FIXED</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .test-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { padding: 15px 25px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #0056b3; transform: translateY(-2px); }
        .result { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .status { font-weight: bold; margin-bottom: 15px; font-size: 18px; }
        .debug { background: #f1f3f4; padding: 15px; border-radius: 6px; margin: 15px 0; font-family: monospace; font-size: 12px; }
        .image-container { text-align: center; margin: 20px 0; }
        .image-container img { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .audio-controls { text-align: center; margin: 20px 0; }
        .progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s ease; width: 0%; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Test Fixes - Image & TTS - FIXED</h1>
        <p style="text-align: center; color: #666; font-size: 16px;">Testing the fixed image generation and TTS functionality with improved validation</p>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="testImageFix()" style="background: #28a745;">üé® Test Image Generation Fix</button>
            <button onclick="testTTSFix()" style="background: #17a2b8;">üîä Test TTS Fix</button>
            <button onclick="testBoth()" style="background: #6f42c1;">üöÄ Test Both Fixes</button>
        </div>

        <div class="progress">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div id="result" class="result">
            <div class="status">Click a test button to verify the fixes...</div>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://al-dalil-ai-worker.speedofmastry.workers.dev';
        let currentTest = '';

        // Improved base64 to blob conversion
        function base64ToBlob(base64, mimeType = 'image/png') {
            try {
                // Remove data URL prefix if present
                const base64Data = base64.replace(/^data:[^;]+;base64,/, '');
                
                // Decode base64 to binary
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                return new Blob([bytes], { type: mimeType });
            } catch (error) {
                console.error('Base64 to blob conversion error:', error);
                throw new Error(`Failed to convert base64 to blob: ${error.message}`);
            }
        }

        // Test image generation fix with improved validation
        async function testImageFix() {
            currentTest = 'image';
            const resultDiv = document.getElementById('result');
            const progressFill = document.getElementById('progress-fill');
            
            resultDiv.innerHTML = '<div class="status">üé® Testing Image Generation Fix...</div>';
            progressFill.style.width = '0%';

            try {
                // Step 1: Generate image
                progressFill.style.width = '25%';
                resultDiv.innerHTML += '<div>üîÑ Step 1: Generating image...</div>';
                
                const response = await fetch(`${WORKER_URL}/ai/image`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: 'A cute cat reading a book' })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(`Image generation failed: ${data.error}`);
                }

                progressFill.style.width = '50%';
                resultDiv.innerHTML += '<div>‚úÖ Step 1: Image generated successfully</div>';
                resultDiv.innerHTML += '<div>üîÑ Step 2: Processing image data...</div>';

                // Step 2: Process image data with better debugging
                const base64Data = data.result;
                console.log('Image Response Data:', data);
                console.log('Base64 Data Type:', typeof base64Data);
                console.log('Base64 Data Length:', base64Data ? base64Data.length : 'null');
                console.log('Base64 Data Preview:', base64Data ? base64Data.substring(0, 100) : 'null');
                
                // More flexible validation
                if (!base64Data) {
                    throw new Error('No image data received from image generation service');
                }
                
                if (typeof base64Data !== 'string') {
                    throw new Error(`Image data is not a string, got: ${typeof base64Data}`);
                }
                
                if (base64Data.length < 50) {
                    throw new Error(`Image data too short: ${base64Data.length} characters (expected at least 50)`);
                }

                // Step 3: Create blob and display
                progressFill.style.width = '75%';
                resultDiv.innerHTML += '<div>‚úÖ Step 2: Image data validated</div>';
                resultDiv.innerHTML += '<div>üîÑ Step 3: Creating image display...</div>';

                const blob = base64ToBlob(base64Data, 'image/png');
                const imageUrl = URL.createObjectURL(blob);

                progressFill.style.width = '100%';
                resultDiv.innerHTML = `
                    <div class="status success">üéâ Image Generation Fix Test PASSED!</div>
                    <div class="debug">
                        <strong>Test Results:</strong><br>
                        ‚úÖ Image generated: ${data.success}<br>
                        ‚úÖ Base64 length: ${base64Data.length} characters<br>
                        ‚úÖ Blob size: ${blob.size} bytes<br>
                        ‚úÖ Blob type: ${blob.type}<br>
                        ‚úÖ Image URL created: ${imageUrl.substring(0, 50)}...
                    </div>
                    <div class="image-container">
                        <img src="${imageUrl}" alt="Generated Cat Reading Book" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                        <div style="display: none; color: #dc3545; font-weight: bold; font-size: 18px;">‚ö†Ô∏è Image failed to load</div>
                    </div>
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; color: #666; font-size: 16px;">üîç View Raw Response</summary>
                        <pre class="debug">${JSON.stringify({...data, result: base64Data.substring(0, 100) + '...'}, null, 2)}</pre>
                    </details>
                `;

            } catch (error) {
                progressFill.style.width = '100%';
                resultDiv.innerHTML = `
                    <div class="status error">‚ùå Image Generation Fix Test FAILED</div>
                    <div class="debug">
                        <strong>Error Details:</strong><br>
                        ${error.message}<br><br>
                        <strong>Stack Trace:</strong><br>
                        ${error.stack}
                    </div>
                `;
            }
        }

        // Test TTS fix with better debugging and fixed error handling
        async function testTTSFix() {
            currentTest = 'tts';
            const resultDiv = document.getElementById('result');
            const progressFill = document.getElementById('progress-fill');
            
            resultDiv.innerHTML = '<div class="status">üîä Testing TTS Fix...</div>';
            progressFill.style.width = '0%';

            let data = null; // Declare data variable in function scope

            try {
                // Step 1: Generate TTS
                progressFill.style.width = '25%';
                resultDiv.innerHTML += '<div>üîÑ Step 1: Generating speech...</div>';
                
                const response = await fetch(`${WORKER_URL}/ai/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: 'Hello, this is a test of the TTS fix!', lang: 'en' })
                });
                
                data = await response.json();
                
                if (!data.success) {
                    throw new Error(`TTS generation failed: ${data.error}`);
                }

                progressFill.style.width = '50%';
                resultDiv.innerHTML += '<div>‚úÖ Step 1: Speech generated successfully</div>';
                resultDiv.innerHTML += '<div>üîÑ Step 2: Processing audio data...</div>';

                // Step 2: Process audio data with better debugging
                const base64Data = data.result;
                console.log('TTS Response Data:', data);
                console.log('Base64 Data Type:', typeof base64Data);
                console.log('Base64 Data Length:', base64Data ? base64Data.length : 'null');
                console.log('Base64 Data Preview:', base64Data ? base64Data.substring(0, 100) : 'null');
                
                // More flexible validation
                if (!base64Data) {
                    throw new Error('No audio data received from TTS service');
                }
                
                if (typeof base64Data !== 'string') {
                    throw new Error(`Audio data is not a string, got: ${typeof base64Data}`);
                }
                
                if (base64Data.length < 50) {
                    throw new Error(`Audio data too short: ${base64Data.length} characters (expected at least 50)`);
                }

                // Step 3: Create audio blob and controls
                progressFill.style.width = '75%';
                resultDiv.innerHTML += '<div>‚úÖ Step 2: Audio data validated</div>';
                resultDiv.innerHTML += '<div>üîÑ Step 3: Creating audio controls...</div>';

                const audioBlob = base64ToBlob(base64Data, 'audio/wav');
                const audioUrl = URL.createObjectURL(audioBlob);

                progressFill.style.width = '100%';
                resultDiv.innerHTML = `
                    <div class="status success">üéâ TTS Fix Test PASSED!</div>
                    <div class="debug">
                        <strong>Test Results:</strong><br>
                        ‚úÖ Speech generated: ${data.success}<br>
                        ‚úÖ Base64 length: ${base64Data.length} characters<br>
                        ‚úÖ Blob size: ${audioBlob.size} bytes<br>
                        ‚úÖ Blob type: ${audioBlob.type}<br>
                        ‚úÖ Audio URL created: ${audioUrl.substring(0, 50)}...
                    </div>
                    <div class="audio-controls">
                        <button onclick="playAudio('${audioUrl}')" style="background: #28a745; font-size: 18px; padding: 20px 30px;">üîä Play Audio</button>
                    </div>
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; color: #666; font-size: 16px;">üîç View Raw Response</summary>
                        <pre class="debug">${JSON.stringify({...data, result: base64Data.substring(0, 100) + '...'}, null, 2)}</pre>
                    </details>
                `;

            } catch (error) {
                progressFill.style.width = '100%';
                resultDiv.innerHTML = `
                    <div class="status error">‚ùå TTS Fix Test FAILED</div>
                    <div class="debug">
                        <strong>Error Details:</strong><br>
                        ${error.message}<br><br>
                        <strong>Raw Response Data:</strong><br>
                        <pre>${JSON.stringify(data || {}, null, 2)}</pre><br>
                        <strong>Stack Trace:</strong><br>
                        ${error.stack}
                    </div>
                `;
            }
        }

        // Test both fixes
        async function testBoth() {
            currentTest = 'both';
            const resultDiv = document.getElementById('result');
            const progressFill = document.getElementById('progress-fill');
            
            resultDiv.innerHTML = '<div class="status">üöÄ Testing Both Fixes...</div>';
            progressFill.style.width = '0%';

            try {
                // Test image first
                progressFill.style.width = '25%';
                resultDiv.innerHTML += '<div>üîÑ Testing Image Generation...</div>';
                await testImageFix();
                
                // Wait a moment
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Test TTS
                progressFill.style.width = '75%';
                resultDiv.innerHTML += '<div>üîÑ Testing TTS...</div>';
                await testTTSFix();
                
                progressFill.style.width = '100%';
                resultDiv.innerHTML += '<div class="status success">üéâ Both Fixes Tested Successfully!</div>';

            } catch (error) {
                progressFill.style.width = '100%';
                resultDiv.innerHTML += `<div class="status error">‚ùå Combined Test Failed: ${error.message}</div>`;
            }
        }

        // Fixed audio playback function
        function playAudio(audioUrl) {
            try {
                console.log('Playing audio from URL:', audioUrl);
                
                // Create new audio element
                const audio = new Audio();
                
                // Set up event listeners
                audio.addEventListener('loadstart', () => console.log('Audio loading started'));
                audio.addEventListener('canplay', () => console.log('Audio can play'));
                audio.addEventListener('playing', () => console.log('Audio playing'));
                audio.addEventListener('ended', () => console.log('Audio ended'));
                audio.addEventListener('error', (e) => console.error('Audio error:', e));
                
                // Set source and play
                audio.src = audioUrl;
                audio.volume = 0.7;
                
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => console.log('Audio playback started successfully'))
                        .catch(error => {
                            console.error('Audio playback failed:', error);
                            alert('Audio playback failed: ' + error.message);
                        });
                }
            } catch (error) {
                console.error('Error in playAudio:', error);
                alert('Error playing audio: ' + error.message);
            }
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('result').innerHTML = `
                    <div class="status">üöÄ Ready to test the fixes!</div>
                    <div style="text-align: center; margin: 20px 0;">
                        <p>Click any test button to verify that the image generation and TTS issues have been resolved.</p>
                        <p><strong>Fixed Issues:</strong></p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>‚úÖ Robust JSON parsing in worker</li>
                            <li>‚úÖ Improved base64 to blob conversion</li>
                            <li>‚úÖ Better error handling and debugging</li>
                            <li>‚úÖ Fixed audio playback</li>
                            <li>‚úÖ Fixed undefined data variable error</li>
                            <li>‚úÖ Improved validation (50+ chars instead of 100+)</li>
                        </ul>
                    </div>
                `;
            }, 1000);
        });
    </script>
</body>
</html>
